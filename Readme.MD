# Docker on Azure

This project deploys Docker EE cluster on Azure with following configuration:
1. UCP: 1 load balancer + 3 managers
2. DTR: 1 load balancer + 3 DTR replicas (named managers as well)
3. Workers: 1 load balancer + 3 worker nodes

# Credits
This project is based on [stevenfollis repo](https://github.com/microsoft/Docker-EE-on-Azure-Stack-Deployment/commits?author=stevenfollis).
Major Changes:
1. Linux system: Centos 7.6
2. System and Azure configuration aligned with requirements of new Docker version: 19.03
3. Azure ARM templates
4. Shell scripts

# How to use it

## Installation
To deploy the stack, execute following steps

1. Using to Powershell login to Azure (az login)
2. Amend the parameters in deploy.ps1 file:
    1. ssh: key used in all linux vms (it is worth to generate a key usign ssh-keygen)
    2. dockerURL: your url to Docker EE. You can obtain it from https://hub.docker.com/
    3. version: 
    4. rg: resource group name - all resources will be placed there
    5. sp_name: service principal name
    6. storageName: name of the storage where scripts will be uploaded and then downloaded by all vms while configuring
    7. domainName: domain name
    8. securityGroupName: name of the security group
    9. vnet_name: name of the virtual machine
3. Inside scripts/Deploy-UCP.sh change default UCP_ADMIN and UCP_PASSWORD :)
4. Execute Deploy.ps1
5. Make a coffee, dinner, go for a walk and come back after (usually) 20 minutes ;)

## Testing
To check if everything works as expected see the instructions below
### UCP
1. Navigate to the url of UCP. Web browser will moan about the unsigned certificate. Ignore and proceed ;) Please note that you may have to refresh browser couple of times (no more than 5) to get the dns name works
2. Login with the admin and password you provided in the installation step 3.
3. Under Shared Resources -> Nodes all 9 nodes should be green
4. Navigate to Admin -> Admin Settings and select the Docker Trusted Registry. You should see that DTR is installed as well as its dns.
### DTR
1. Navigate to the dtr DNS - again please note that dns may require several browser refresh to start working. You can find dtr address either in DTR public ip in Azure or in above point 1.d.
2. Again, ignore moaning about the certificate
3. If asked use same credentials as in 1.b
4. Under Repositories click Create New Repository, provide a name and click Create.
5. You should see your repository added
### Test App (Stack):
1. Navigate to Shared Resources -> Stacks and click Create Stack. 
2. Provide random name, leave Swarm Services and Compose File and click next.
3. Navigate to the [Docker Stack Example](https://raw.githubusercontent.com/dockersamples/example-voting-app/master/docker-stack.yml) copy the content and paste to the Add Application file. Click Create.
4. Click Ready once is done
5. Navigate to the deployed stack and click on Services tabs. All services should be green. Click on stackname_visualizer service - note the endpoint.
6. Inside the Azure Portal find the Network Security Group and add inboud rule on port 8080
7. Navigate to the endpoint from your stack name - you should see website.

## Debuggin
Now this is fun :)
1. Whenever deploying any azure arm template add flag --debug - this will help you to see if Azure sees any problem
2. Read Azure [prerequisits](https://docs.docker.com/ee/ucp/admin/install/cloudproviders/install-on-azure/) and check if you follow them. Any deviation....
1. SSH to manager 1 and check following elements:
    1. sudo cat /etc/kubernetes/azure.json - this file should look according to the [template](https://github.com/kubernetes/cloud-provider-azure/blob/master/docs/cloud-provider-config.md)
    2. Still on manager one go to: /var/lib/waagent/custom-script/download/0/ and read stderr and stdout. Content of these files are generated by the scripts which resides in the same folder [Azure Custom VM Scripts on Linux v2](https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/custom-script-linux)
2. In case any of the node is "not green" repeat the steps 1 and 2 above


# Contributing
Now this definitely can be improved!! First of all I would like to use Azure VM Scale Set yet I'm having some issues with vm and hostname naming convention which prevents making worker nodes get into the ready state. There also other improvements in my mind! If time permits I'll work on them
You may also find some other improvements so feel free to contribute.
There is a standard Contributing message below - kindly ask you to follow this advice:

> Pull requests are welcome. For major changes, please open an issue first to discuss what you would like to change.
> Please make sure to update tests as appropriate.

# License
Licences are too complicated for me :P use it, modified it, have fun with it, earn money. And in case you meet me - high5 and I drink beers, whiskey ;)

# Contact
Feel free to drop me a note in case of questions